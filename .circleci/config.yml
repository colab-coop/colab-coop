version: 2.1

executors:
  coopctl:
    docker:
      - image: colabcoop/deploy:0.0.33
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASSWORD

jobs:
  production:
    executor: coopctl
    environment:
      HELMFILE_ENVIRONMENT: production
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.6
          docker_layer_caching: true
      - run:
          name: Deploy to Production Cluster
          command: coopctl deploy
  staging:
    executor: coopctl
    environment:
      HELMFILE_ENVIRONMENT: staging
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.6
          docker_layer_caching: true
      - run:
          name: Deploy to Staging Cluster
          command: coopctl deploy

workflows:
  deploy:
    jobs:
      - production:
          context: colab-kube-production-v1
          filters:
            branches:
              only: production
      - staging:
          context: colab-kube-staging-v1
          filters:
            branches:
              only: staging
